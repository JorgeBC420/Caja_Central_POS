{% extends "base.html" %}

{% block title %}Productos - POS Mobile{% endblock %}

{% block content %}
<div class="container mt-3">
    <!-- Header -->
    <div class="card bg-info text-white">
        <div class="card-body py-3">
            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Catálogo de Productos</h5>
            <small>Explora todos los productos disponibles</small>
        </div>
    </div>

    <!-- Buscador -->
    <div class="card">
        <div class="card-body py-2">
            <form method="GET" action="{{ url_for('products') }}">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" 
                           class="form-control" 
                           name="search" 
                           value="{{ search }}"
                           placeholder="Buscar por nombre o código..."
                           autocomplete="off">
                    <button class="btn btn-primary" type="submit">Buscar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtros rápidos -->
    <div class="card">
        <div class="card-body py-2">
            <div class="row">
                <div class="col">
                    <small class="text-muted">Filtros rápidos:</small>
                </div>
            </div>
            <div class="d-flex gap-2 mt-1">
                <button class="btn btn-sm btn-outline-primary" onclick="filterByStock('all')">
                    Todos
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="filterByStock('available')">
                    Con Stock
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="filterByStock('low')">
                    Stock Bajo
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="filterByStock('out')">
                    Sin Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de productos -->
    {% if products %}
    <div class="row" id="products-container">
        {% for product in products %}
        <div class="col-12 col-md-6 col-lg-4 mb-3 product-item" 
             data-stock="{{ product.stock }}"
             data-name="{{ product.nombre.lower() }}"
             data-code="{{ product.codigo.lower() }}">
            <div class="card product-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">{{ product.nombre }}</h6>
                            <small class="text-muted">Código: {{ product.codigo or 'N/A' }}</small>
                        </div>
                        <i class="bi bi-box text-primary fs-4"></i>
                    </div>
                    
                    <div class="mb-2">
                        <span class="price-tag">₡{{ "{:,.0f}".format(product.precio) }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if product.stock > 10 %}
                                <span class="badge bg-success">Stock: {{ product.stock }}</span>
                            {% elif product.stock > 0 %}
                                <span class="badge bg-warning">Stock: {{ product.stock }}</span>
                            {% else %}
                                <span class="badge bg-danger">Sin stock</span>
                            {% endif %}
                        </div>
                        
                        {% if product.stock > 0 %}
                        <button class="btn btn-sm btn-success" 
                                onclick="addToQuickSale({{ product.id }}, '{{ product.nombre }}', {{ product.precio }})">
                            <i class="bi bi-cart-plus"></i>
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-secondary" disabled>
                            <i class="bi bi-x-circle"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Información de resultados -->
    <div class="card">
        <div class="card-body py-2 text-center">
            <small class="text-muted">
                Mostrando {{ products|length }} producto{{ 's' if products|length != 1 else '' }}
                {% if search %} para "{{ search }}"{% endif %}
            </small>
        </div>
    </div>

    {% else %}
    <!-- No hay productos -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No se encontraron productos</h5>
            {% if search %}
            <p class="text-muted">No hay productos que coincidan con "{{ search }}"</p>
            <a href="{{ url_for('products') }}" class="btn btn-primary">Ver todos los productos</a>
            {% else %}
            <p class="text-muted">Aún no hay productos registrados en el sistema</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Toast para feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="productToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Éxito</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Producto agregado al carrito
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let quickCart = JSON.parse(localStorage.getItem('quickCart') || '[]');

function filterByStock(type) {
    const products = document.querySelectorAll('.product-item');
    
    products.forEach(product => {
        const stock = parseInt(product.dataset.stock);
        let show = false;
        
        switch(type) {
            case 'all':
                show = true;
                break;
            case 'available':
                show = stock > 0;
                break;
            case 'low':
                show = stock > 0 && stock <= 10;
                break;
            case 'out':
                show = stock === 0;
                break;
        }
        
        product.style.display = show ? 'block' : 'none';
    });
    
    // Actualizar botones activos
    document.querySelectorAll('.btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-danger')
        .forEach(btn => btn.classList.remove('active'));
    
    event.target.classList.add('active');
}

function addToQuickSale(productId, productName, price) {
    // Agregar al carrito local
    const existingItem = quickCart.find(item => item.id === productId);
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        quickCart.push({
            id: productId,
            name: productName,
            price: price,
            quantity: 1
        });
    }
    
    // Guardar en localStorage
    localStorage.setItem('quickCart', JSON.stringify(quickCart));
    
    // Mostrar toast
    showToast(`${productName} agregado al carrito`);
    
    // Feedback visual
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i>';
    button.classList.remove('btn-success');
    button.classList.add('btn-primary');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
    }, 1000);
}

function showToast(message) {
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('productToast'));
    toast.show();
}

// Búsqueda en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterProductsRealTime(this.value);
            }, 300);
        });
    }
});

function filterProductsRealTime(searchTerm) {
    const products = document.querySelectorAll('.product-item');
    const term = searchTerm.toLowerCase();
    
    products.forEach(product => {
        const name = product.dataset.name;
        const code = product.dataset.code;
        const matches = name.includes(term) || code.includes(term);
        product.style.display = matches ? 'block' : 'none';
    });
}

// Actualizar contador del carrito si existe
function updateCartCounter() {
    const counter = document.querySelector('.cart-counter');
    if (counter) {
        const totalItems = quickCart.reduce((sum, item) => sum + item.quantity, 0);
        counter.textContent = totalItems;
    }
}

// Inicializar
updateCartCounter();
</script>
{% endblock %}
